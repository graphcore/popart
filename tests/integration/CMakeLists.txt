

add_popart_cpp_unit_test(accumulateouterfragmentparallelizertest accumulateouterfragmentparallelizer_test.cpp VARIANTS "IpuModel")
add_popart_cpp_unit_test(aliaszerocopytest aliaszerocopy_test.cpp)
add_popart_cpp_unit_test(aliaszerocopytest1 aliaszerocopy_test1.cpp)
add_popart_cpp_unit_test(allocatortest allocator_test.cpp)
add_popart_cpp_unit_test(boollogictest boollogic_test.cpp)
add_popart_cpp_unit_test(buildertest builder_test.cpp)
add_popart_cpp_unit_test(builderpartialstest builder_partials_test.cpp)
add_popart_cpp_unit_test(casttest cast_test.cpp)
add_popart_cpp_unit_test(collectivestest collectives_test.cpp VARIANTS "Hw")
add_popart_cpp_unit_test(custompatterntest custom_pattern_test.cpp)
add_popart_cpp_unit_test(dataflowtest dataflowtest.cpp)
add_popart_cpp_unit_test(decomposegradientsummationtest decompose_gradient_summation_test.cpp)
add_popart_cpp_unit_test(executable_serialization_test executable_serialization_test.cpp VARIANTS "Hw")
add_popart_cpp_unit_test(graphedgemaptest graph_edgemap_test.cpp TEST_UTILS test-graphs-test-util)
add_popart_cpp_unit_test(exceptiontest exceptiontest.cpp)
add_popart_cpp_unit_test(inputshapeinfotest inputshapeinfotest.cpp)
add_popart_cpp_unit_test(irhashtest ir_hash_test.cpp VARIANTS "IpuModel")
add_popart_cpp_unit_test(isnonlinearitytest is_nonlinearity_test.cpp)
add_popart_cpp_unit_test(isnormtest is_norm_test.cpp)
add_popart_cpp_unit_test(loggingtest loggingtest.cpp)
add_popart_cpp_unit_test(maxcliquetest maxclique_test.cpp)
add_popart_cpp_unit_test(mergecopiestest mergecopies_test.cpp)
add_popart_cpp_unit_test(nogradoptest no_gradop_test.cpp)
add_popart_cpp_unit_test(numpybroadcastshapetest numpybroadcastshapetest.cpp)
add_popart_cpp_unit_test(opmanagertest op_manager_test.cpp)
add_popart_cpp_unit_test(opxtensoraliasingtest opx_tensor_aliasing_test.cpp)
add_popart_cpp_unit_test(outliningirtest outlining_ir_test.cpp)
add_popart_cpp_unit_test(poprithmstransitiveclosuretest poprithmstransitiveclosure_test.cpp TEST_UTILS test-graphs-test-util)
add_popart_cpp_unit_test(prunetest prune_test.cpp TEST_UTILS test-graphs-test-util)
add_popart_cpp_unit_test(simple_addition_test simple_addition_test.cpp)
add_popart_cpp_unit_test(subgraph_partitioning_test subgraph_partitioning_test.cpp)
add_popart_cpp_unit_test(syncpatterntest sync_pattern_test.cpp VARIANTS "Hw")
add_popart_cpp_unit_test(syntheticdatatest synthetic_data_test.cpp)
add_popart_cpp_unit_test(transformtest transform_test.cpp)
add_popart_cpp_unit_test(vertex_vgid_test vertex_vgid_test.cpp VARIANTS "IpuModel")
add_popart_cpp_unit_test(viewchangingtest view_changing_test.cpp)
add_popart_cpp_unit_test(debuginfotest debug_info_test.cpp)

add_popart_cpp_unit_test(constop_test constop_test.cpp)
add_popart_cpp_unit_test(opsetcheck_test opset_check_test.cpp)
add_popart_cpp_unit_test(preplan_convolutions_test preplan_convolutions_test.cpp VARIANTS "IpuModel")
add_popart_cpp_unit_test(preplan_matmuls_test preplan_matmuls_test.cpp VARIANTS "IpuModel")

# add_popart_py_unit_test(test_util test_util.py) Utility
# add_popart_py_unit_test(test_session test_session.py) Utility

# Python tests. Please try to sort alphabetically.
add_popart_py_unit_test(abort_test abort_test.py VARIANTS Hw)
add_popart_py_unit_test(addbias addbias.py)
add_popart_py_unit_test(aliaszerocopy_model_test aliaszerocopy_model_test.py VARIANTS IpuModel)
add_popart_py_unit_test(all_constexpr all_constexpr.py)
add_popart_py_unit_test(anchorreturntype_test anchorreturntype_test.py VARIANTS Hw)
add_popart_py_unit_test(annotations_test annotations_test.py)
add_popart_py_unit_test(auto_loss_scaling_graph_replication_test auto_loss_scaling_graph_replication_test.py VARIANTS Hw)
add_popart_py_unit_test(auto_virtual_graph_test auto_virtual_graph_test.py VARIANTS IpuModel)
add_popart_py_unit_test(builder_name_test builder_name_test.py)
add_popart_py_unit_test(builder_test builder_test.py)
add_popart_py_unit_test(clip_by_norm_test clip_by_norm_test.py)
add_popart_py_unit_test(collectives_test collectives_test.py VARIANTS Hw)
add_popart_py_unit_test(context_scope_test context_scope_test.py)
add_popart_py_unit_test(convolution_options_test convolution_options_test.py VARIANTS IpuModel)
add_popart_py_unit_test(cycle_count_test cycle_count_test.py VARIANTS Hw)

add_popart_py_unit_test(decompose_gradient_summation_test decompose_gradient_summation_test.py VARIANTS IpuModel)
add_popart_py_unit_test(device_test device_test.py VARIANTS Hw)
add_popart_py_unit_test(dim_param_test dim_param_test.py)
add_popart_py_unit_test(doc_test doc_test.py)
add_popart_py_unit_test(dont_inplace_test dont_inplace_test.py)
add_popart_py_unit_test(dropout_replicated_pipeline dropout_replicated_pipeline.py VARIANTS Hw)
add_popart_py_unit_test(enhanced_debug enhanced_debug.py)
add_popart_py_unit_test(exception_test exception_test.py VARIANTS Hw)
add_popart_py_unit_test(export_test export_test.py)
add_popart_py_unit_test(float_to_half_conversion_test float_to_half_conversion_test.py)
add_popart_py_unit_test(fp16_test fp16_test.py)
# The gradient_accumulation_test file is ran in separate ctest tests as they take a long time.
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_base VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_multi_batch VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_multi_ipu VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_error_inference VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_error_accum_factor_invalid VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_gradient_accumulation_model_proto VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_loading_saved_gradient_accumulationt_tensors VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_adam_gradient_accumulation_base VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_adam_gradient_accumulation_multi_batch VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_adam_gradient_accumulation_multi_ipu VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_adam_gradient_accumulation_model_proto VARIANTS IpuModel)
add_popart_py_unit_test(gradient_accumulation_test gradient_accumulation_test.py MATCHEXPR test_adam_loading_saved_gradient_accumulationt_tensors VARIANTS IpuModel)
# TODO: re-enable when T41374 is fixed
#add_popart_py_unit_test(graph_caching_test graph_caching_test.py VARIANTS IpuModel)
add_popart_py_unit_test(graph_replication_test graph_replication_test.py VARIANTS Hw)
add_popart_py_unit_test(import_test import_test.py)
add_popart_py_unit_test(ipu_copy_test ipu_copy_test.py VARIANTS IpuModel)
add_popart_py_unit_test(loader_test loader_test.py)
add_popart_py_unit_test(loss_scaling_clip_test loss_scaling_clip_test.py)
add_popart_py_unit_test(loss_scaling_test loss_scaling_test.py VARIANTS IpuModel)
add_popart_py_unit_test(net_test net_test.py)
add_popart_py_unit_test(np_memory_layout_test np_memory_layout_test.py)
add_popart_py_unit_test(offline_compilation offline_compilation.py)
add_popart_py_unit_test(optimizer_test optimizer_test.py)
add_popart_py_unit_test(options_test options_test.py)
add_popart_py_unit_test(outlining_test outlining_test.py)
add_popart_py_unit_test(outlining_execution_context_test outlining_execution_context_test.py VARIANTS "Hw")
add_popart_py_unit_test(padsumpattern padsumpattern.py)
add_popart_py_unit_test(partials_tests partials_tests.py VARIANTS IpuModel)
add_popart_py_unit_test(patterns_test patterns_test.py)
add_popart_py_unit_test(prefetch_test prefetch_test.py VARIANTS Hw)
add_popart_py_unit_test(printtensor printtensor.py)
add_popart_py_unit_test(prune_all_error_test prune_all_error_test.py)
add_popart_py_unit_test(random_test random_test.py VARIANTS Hw)
add_popart_py_unit_test(randomsetup_test randomsetup_test.py VARIANTS Hw)
add_popart_py_unit_test(recompute_compatibility_test recompute_compatibility_test.py)
add_popart_py_unit_test(report_test report_test.py VARIANTS IpuModel)
add_popart_py_unit_test(report_test_cpu report_test_cpu.py)
add_popart_py_unit_test(saved_executable saved_executable.py VARIANTS Hw)
add_popart_py_unit_test(saved_executable_cpu saved_executable_cpu.py)
#Temporarily disabled, see T22702.
#add_popart_py_unit_test(serialise_matmul_manually serialise_matmul_manually.py)
add_popart_py_unit_test(stream_test stream_test.py)
add_popart_py_unit_test(stubs_test stubs_test.py)
add_popart_py_unit_test(synthetic_data_test synthetic_data_test.py VARIANTS Hw)
add_popart_py_unit_test(test_groupHostSync test_groupHostSync.py VARIANTS IpuModel)
add_popart_py_unit_test(train_then_infer_test train_then_infer_test.py VARIANTS IpuModel)
add_popart_py_unit_test(variable_inference_test variable_inference_test.py)
add_popart_py_unit_test(virtual_graph_check_test virtual_graph_check_test.py)
add_popart_py_unit_test(virtual_graph_test virtual_graph_test.py VARIANTS IpuModel)
add_popart_py_unit_test(type_casting_test type_casting_test.py)
add_popart_py_unit_test(supported_ops_test supported_ops_test.py)
add_popart_py_unit_test(constant_op_test constant_op_test.py)
add_popart_py_unit_test(nop_test nop_test.py)
add_popart_py_unit_test(external_tensorproto_data_test external_tensorproto_data_test.py)
add_popart_py_unit_test(debug_info_test debug_info_test.py)
add_popart_py_unit_test(logging_test logging_test.py)
add_popart_py_unit_test(model_loading_test model_loading_test.py)
add_popart_py_unit_test(loss_grad_scaling_with_replication loss_grad_scaling_with_replication.py VARIANTS Hw)
add_popart_py_unit_test(int8_host_stream_test int8_host_stream_test.py VARIANTS IpuModel)
add_popart_py_unit_test(identical_replica_test identical_replica_test.py VARIANTS Hw)
add_popart_py_unit_test(version_test version_test.py)

# Test to check for boost in popart headers.
set(POPART_INCLUDE_DIR ${PROJECT_SOURCE_DIR}/willow/include)
add_test(NAME "boost_free_interface_test"
  COMMAND ${Python3_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/boost_free_interface_test.py ${POPART_INCLUDE_DIR})

if ("Hw" IN_LIST ENABLED_TEST_VARIANTS)
  # device_test should be run serially as it tests that it can attach to each
  # IPU available on the machine it is run on.
  set_tests_properties("Hw_default_device_test" PROPERTIES RUN_SERIAL TRUE)

  # Run serially to avoid IPU attachment conflicts:
  # Uses all IPUs
  set_tests_properties("Hw_default_cycle_count_test" PROPERTIES RUN_SERIAL TRUE)
  # Doesn't wait to attach
  set_tests_properties("Hw_default_syncpatterntest" PROPERTIES RUN_SERIAL TRUE) 
endif()

add_subdirectory(anchor_tests)
add_subdirectory(auto_virtual_graph_tests)
add_subdirectory(codelet_tests)
add_subdirectory(constexpr_tests)
add_subdirectory(dot_tests)
add_subdirectory(dropout_tests)
add_subdirectory(inplaceaccumulategradpartialsintooptimizeraccumtensor_tests)
add_subdirectory(inplace_tests)
add_subdirectory(lambserialisedweight_tests)
add_subdirectory(logical_if_tests)
add_subdirectory(matmul_tests)
add_subdirectory(operators_test)
add_subdirectory(optimizer_tests)
add_subdirectory(pattern_tests)
add_subdirectory(streamingmemory_tests)
add_subdirectory(pipelining_tests)
add_subdirectory(recompute_tests)
add_subdirectory(scheduling_tests)
add_subdirectory(session_api_tests)
add_subdirectory(stepio_tests)
add_subdirectory(subgraph_tests)
add_subdirectory(tensor_tests)
add_subdirectory(tiedgather_tests)
add_subdirectory(topk_tests)
add_subdirectory(transformation_tests)
add_subdirectory(slice_pad_dual_tests)
add_subdirectory(verify_cxx_11_interface)
